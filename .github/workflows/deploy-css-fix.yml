name: Deploy CSS Fix to Production

on:
  workflow_dispatch:
    inputs:
      clear_cache:
        description: 'Clear CloudFront cache'
        required: true
        default: 'yes'
        type: choice
        options:
        - yes
        - no
  
  push:
    branches: [main]
    paths:
      - 'src/static/css/**'
      - 'src/templates/**/*.html'
      - 'src/apps/**/templates/**/*.html'
      - 'src/tailwind.config.js'
      - 'src/package.json'

jobs:
  deploy-css:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy CSS Fix to Production
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: ${{ secrets.PRODUCTION_PORT || 22 }}
        script: |
          cd /path/to/fahanie-cares
          
          # Pull latest changes
          git pull origin main
          
          # Find web container
          WEB_CONTAINER=$(docker ps --format "{{.Names}}" | grep -E "(web|django|fahanie)" | head -1)
          
          if [ ! -z "$WEB_CONTAINER" ]; then
            # Rebuild CSS
            docker exec $WEB_CONTAINER npm run build-css
            
            # Collect static
            docker exec $WEB_CONTAINER python manage.py collectstatic --noinput
            
            echo "✅ CSS deployed successfully"
          else
            echo "❌ Could not find web container"
            exit 1
          fi
    
    - name: Clear CloudFront Cache
      if: github.event.inputs.clear_cache == 'yes' || github.event_name == 'push'
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION || 'ap-southeast-1' }}
      run: |
        # Install AWS CLI
        pip install awscli
        
        # Find distribution
        DIST_ID=$(aws cloudfront list-distributions \
          --query "DistributionList.Items[?contains(Aliases.Items || [''], 'fahaniecares.ph')].Id" \
          --output text)
        
        if [ ! -z "$DIST_ID" ]; then
          aws cloudfront create-invalidation \
            --distribution-id $DIST_ID \
            --paths "/*"
          echo "✅ CloudFront cache cleared"
        else
          echo "⚠️ Could not find CloudFront distribution"
        fi