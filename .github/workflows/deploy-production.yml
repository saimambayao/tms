name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_cache_invalidation:
        description: 'Skip CloudFront cache invalidation'
        required: false
        default: 'false'
        type: boolean

env:
  AWS_REGION: ap-southeast-1

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git versioning

      - name: Generate version info
        id: version
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "deploy_id=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT
          echo "branch=$(git branch --show-current)" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: src/package-lock.json

      - name: Install and build frontend
        working-directory: ./src
        run: |
          npm ci
          echo "/* Build: ${{ steps.version.outputs.sha_short }} */" > static/css/version.css
          npm run build-css
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build Docker image
        run: |
          docker build \
            --build-arg STATIC_VERSION=${{ steps.version.outputs.sha_short }} \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --tag fahaniecares:${{ steps.version.outputs.sha_short }} \
            --tag fahaniecares:latest \
            --file deployment/docker/Dockerfile.production \
            .

      - name: Deploy to server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
          
          # Deploy
          ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST << 'ENDSSH'
            cd /opt/fahaniecares
            git pull origin main
            docker-compose -f docker-compose.production.yml build
            docker-compose -f docker-compose.production.yml up -d
            docker system prune -f
          ENDSSH

      - name: Wait for deployment
        run: |
          echo "Waiting for application to start..."
          sleep 45
          
      - name: Health check
        id: health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://fahaniecares.ph/health/)
          echo "status=$response" >> $GITHUB_OUTPUT
          if [ "$response" != "200" ]; then
            echo "Health check failed with status: $response"
            exit 1
          fi

      - name: Invalidate CloudFront cache
        if: ${{ github.event.inputs.skip_cache_invalidation != 'true' }}
        run: |
          DISTRIBUTION_ID="${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
          
          if [ -z "$DISTRIBUTION_ID" ]; then
            echo "No CloudFront distribution ID configured, skipping invalidation"
            exit 0
          fi
          
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "Created invalidation: $INVALIDATION_ID"
          
          # Wait for invalidation
          aws cloudfront wait invalidation-completed \
            --distribution-id $DISTRIBUTION_ID \
            --id $INVALIDATION_ID || echo "Invalidation wait timed out"

      - name: Verify CSS update
        run: |
          # Check if new CSS is being served
          css_headers=$(curl -s -I https://fahaniecares.ph/static/css/output.css)
          echo "CSS Headers:"
          echo "$css_headers" | grep -E "(last-modified|etag|x-cache|cache-control)"

      - name: Create deployment record
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              description: 'Production deployment',
              auto_merge: false,
              required_contexts: []
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: '${{ job.status }}',
              environment_url: 'https://fahaniecares.ph',
              description: 'Deployment ${{ job.status }}'
            });

      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Deployment ${{ job.status }}
            Version: ${{ steps.version.outputs.sha_short }}
            Health: ${{ steps.health.outputs.status }}
            URL: https://fahaniecares.ph
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          
  post-deployment:
    name: Post-deployment verification
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
      - name: Run smoke tests
        run: |
          # Test critical pages
          for url in "/" "/about/" "/programs/" "/static/css/output.css"; do
            echo "Testing $url..."
            status=$(curl -s -o /dev/null -w "%{http_code}" "https://fahaniecares.ph$url")
            if [ "$status" != "200" ] && [ "$status" != "304" ]; then
              echo "Failed: $url returned $status"
              exit 1
            fi
          done
          echo "All smoke tests passed!"

      - name: Check static version
        run: |
          # Check if static version endpoint exists
          curl -s https://fahaniecares.ph/health/static-version/ | jq . || echo "No version endpoint yet"