# SSL Security Configuration for #FahanieCares
# This file contains production-ready SSL/TLS security settings
# Include this in your nginx configuration for enhanced security

# Modern SSL configuration based on Mozilla SSL Configuration Generator
# https://ssl-config.mozilla.org/

# SSL Certificate Configuration
ssl_certificate /etc/nginx/ssl/fullchain.pem;
ssl_certificate_key /etc/nginx/ssl/privkey.pem;

# SSL Protocol Configuration
# Only allow TLSv1.2 and TLSv1.3 (most secure)
ssl_protocols TLSv1.2 TLSv1.3;

# SSL Cipher Configuration
# Modern cipher suite for maximum security
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;

# Prefer server ciphers (disabled for modern configuration)
ssl_prefer_server_ciphers off;

# SSL Session Configuration
ssl_session_timeout 1d;
ssl_session_cache shared:SSL:50m;
ssl_session_tickets off;

# OCSP Stapling Configuration
# Enables OCSP stapling for faster certificate validation
ssl_stapling on;
ssl_stapling_verify on;

# Trusted certificate for OCSP stapling
ssl_trusted_certificate /etc/nginx/ssl/fullchain.pem;

# DNS resolver for OCSP stapling (Google DNS)
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;

# Diffie-Hellman Parameters
# Generate with: openssl dhparam -out /etc/nginx/dhparam/dhparam.pem 2048
ssl_dhparam /etc/nginx/dhparam/dhparam.pem;

# Security Headers
# These headers enhance security and should be included on all HTTPS pages

# HTTP Strict Transport Security (HSTS)
# Forces browsers to use HTTPS for all future requests
add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

# X-Content-Type-Options
# Prevents browsers from MIME-sniffing responses
add_header X-Content-Type-Options "nosniff" always;

# X-Frame-Options
# Prevents clickjacking attacks
add_header X-Frame-Options "DENY" always;

# X-XSS-Protection
# Enables built-in XSS protection in browsers
add_header X-XSS-Protection "1; mode=block" always;

# Referrer Policy
# Controls how much referrer information is sent with requests
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Content Security Policy (CSP)
# Prevents XSS and other code injection attacks
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self'; media-src 'self'; object-src 'none'; child-src 'self'; frame-ancestors 'none'; form-action 'self'; base-uri 'self';" always;

# Feature Policy / Permissions Policy
# Controls which browser features can be used
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# Additional Security Configurations

# Disable server tokens to hide nginx version
server_tokens off;

# Set maximum request size (adjust as needed)
client_max_body_size 50M;

# Timeout configurations for better security
client_body_timeout 10s;
client_header_timeout 10s;
keepalive_timeout 65s 65s;
send_timeout 10s;

# Buffer overflow protection
client_body_buffer_size 200K;
client_header_buffer_size 2k;
client_max_body_size 200k;
large_client_header_buffers 3 1k;

# Rate Limiting (define in main nginx.conf)
# limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
# limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;

# SSL Certificate Monitoring
# Log SSL handshake errors for monitoring
error_log /var/log/nginx/ssl_error.log warn;

# Performance Optimizations

# Enable SSL session resumption
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;

# Optimize SSL buffer size
ssl_buffer_size 4k;

# Gzip Compression (if not defined elsewhere)
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_comp_level 6;
gzip_types
    application/atom+xml
    application/geo+json
    application/javascript
    application/x-javascript
    application/json
    application/ld+json
    application/manifest+json
    application/rdf+xml
    application/rss+xml
    application/xhtml+xml
    application/xml
    font/eot
    font/otf
    font/ttf
    image/svg+xml
    text/css
    text/javascript
    text/plain
    text/xml;

# Hide sensitive files and directories
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

location ~ ~$ {
    deny all;
    access_log off;
    log_not_found off;
}

location ~* \.(sql|log|conf)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Government Security Compliance Notes:
# 
# 1. These settings follow NIST cybersecurity guidelines
# 2. HSTS preload helps with government security requirements
# 3. Strong CSP prevents code injection attacks
# 4. OCSP stapling improves certificate validation performance
# 5. Regular security header updates maintain compliance
#
# Additional Considerations:
# - Regularly update SSL certificates (automated via Let's Encrypt)
# - Monitor SSL Labs rating (should be A+ with these settings)
# - Log and monitor SSL-related errors
# - Implement additional monitoring for certificate expiry
# - Consider implementing Certificate Transparency monitoring
#
# This configuration is designed to achieve:
# - SSL Labs A+ rating
# - NIST compliance
# - Government security standards
# - Modern browser compatibility
# - Optimal performance