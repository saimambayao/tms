# Task ID: 072
# Title: Verify Phase 6 Complete
# Status: pending
# Dependencies: 071
# Priority: high
# Description: Comprehensive verification that Phase 6 (Student Model Transition) is complete. This includes checking all migrations, testing functionality, verifyin

# Details:
Comprehensive verification that Phase 6 (Student Model Transition) is complete. This includes checking all migrations, testing functionality, verifying data integrity, and ensuring all components are working together properly.

## Implementation Steps:
1. Create comprehensive Phase 6 verification script:
   ```bash
   cat > /Users/saidamenmambayao/apps/madaris-ms/scripts/verify_phase6_complete.py << 'EOF'
   #!/usr/bin/env python
   """Comprehensive Phase 6 verification script"""

   import os
   import sys
   import django
   from datetime import datetime

   sys.path.insert(0, '/Users/saidamenmambayao/apps/madaris-ms/src')
   os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
   django.setup()

   from django.core.management import call_command
   from django.contrib.admin.sites import site
   from django.urls import reverse
   from apps.constituents.models import Student
   from apps.constituents.admin import StudentAdmin
   from apps.constituents.forms import StudentEnrollmentForm, StudentSearchForm

   print("=" * 70)
   print("PHASE 6 - STUDENT MODEL TRANSITION - VERIFICATION")
   print(f"Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
   print("=" * 70)

   # 1. Check Migrations
   print("\n1. MIGRATIONS CHECK")
   print("-" * 70)
   from django.db.migrations.executor import MigrationExecutor
   from django.db import connection

   executor = MigrationExecutor(connection)
   plan = executor.migration_plan(executor.loader.graph.leaf_nodes())

   if plan:
       print(f"⚠️  WARNING: {len(plan)} unapplied migrations:")
       for migration, backwards in plan:
           print(f"   - {migration}")
   else:
       print("✓ All migrations applied")

   # 2. Model Verification
   print("\n2. MODEL VERIFICATION")
   print("-" * 70)

   # Check Student model exists
   try:
       student_count = Student.objects.count()
       print(f"✓ Student model accessible: {student_count} records")
   except Exception as e:
       print(f"✗ ERROR: Student model not accessible: {e}")

   # Check required fields
   required_fields = [
       'student_number', 'enrollment_status', 'current_grade_level',
       'first_name', 'last_name', 'birth_date', 'gender',
       'father_name', 'mother_name', 'guardian_name', 'guardian_contact'
   ]

   model_fields = [f.name for f in Student._meta.get_fields()]
   missing_fields = [f for f in required_fields if f not in model_fields]

   if missing_fields:
       print(f"✗ ERROR: Missing fields: {', '.join(missing_fields)}")
   else:
       print(f"✓ All required fields present ({len(required_fields)} fields)")

   # Check BMParliamentMember doesn't exist
   try:
       from apps.constituents.models import BMParliamentMember
       print("⚠️  WARNING: BMParliamentMember model still exists")
   except ImportError:
       print("✓ BMParliamentMember model removed")

   # 3. Admin Interface Check
   print("\n3. ADMIN INTERFACE CHECK")
   print("-" * 70)

   if Student in site._registry:
       admin_class = site._registry[Student]
       print(f"✓ Student admin registered: {admin_class.__name__}")
       print(f"✓ List display: {len(admin_class.list_display)} fields")
       print(f"✓ List filters: {len(admin_class.list_filter)} filters")
       print(f"✓ Search fields: {len(admin_class.search_fields)} fields")
       print(f"✓ Custom actions: {len(admin_class.actions)} actions")
   else:
       print("✗ ERROR: Student admin not registered")

   # 4. Forms Verification
   print("\n4. FORMS VERIFICATION")
   print("-" * 70)

   # Test StudentEnrollmentForm
   try:
       form = StudentEnrollmentForm()
       print(f"✓ StudentEnrollmentForm instantiated")
       print(f"  Fields: {len(form.fields)}")
   except Exception as e:
       print(f"✗ ERROR: StudentEnrollmentForm failed: {e}")

   # Test StudentSearchForm
   try:
       form = StudentSearchForm()
       print(f"✓ StudentSearchForm instantiated")
   except Exception as e:
       print(f"✗ ERROR: StudentSearchForm failed: {e}")

   # 5. URL Configuration Check
   print("\n5. URL CONFIGURATION CHECK")
   print("-" * 70)

   urls_to_check = [
       'student_list',
       'enroll_student',
       # Add more as needed
   ]

   for url_name in urls_to_check:
       try:
           url = reverse(url_name)
           print(f"✓ {url_name}: {url}")
       except Exception as e:
           print(f"✗ ERROR: {url_name} not configured")

   # 6. Data Integrity Check
   print("\n6. DATA INTEGRITY CHECK")
   print("-" * 70)

   total_students = Student.objects.count()
   print(f"Total students: {total_students}")

   # Student numbers
   with_student_number = Student.objects.exclude(student_number__isnull=True).exclude(student_number='').count()
   print(f"✓ Students with student_number: {with_student_number}/{total_students}")

   # Enrollment status
   for status, label in Student.EnrollmentStatus.choices:
       count = Student.objects.filter(enrollment_status=status).count()
       percentage = (count / total_students * 100) if total_students > 0 else 0
       print(f"  {label}: {count} ({percentage:.1f}%)")

   # 7. Foreign Key References Check
   print("\n7. FOREIGN KEY REFERENCES CHECK")
   print("-" * 70)

   from django.apps import apps

   # Find models with ForeignKey to Student
   related_models = []
   for model in apps.get_models():
       for field in model._meta.get_fields():
           if hasattr(field, 'related_model') and field.related_model == Student:
               related_models.append((model.__name__, field.name))

   print(f"Models with ForeignKey to Student: {len(related_models)}")
   for model_name, field_name in related_models:
       print(f"  - {model_name}.{field_name}")

   # Check for BMParliamentMember references
   bm_references = []
   for model in apps.get_models():
       for field in model._meta.get_fields():
           if hasattr(field, 'related_model'):
               if field.related_model and 'BMParliamentMember' in str(field.related_model):
                   bm_references.append((model.__name__, field.name))

   if bm_references:
       print(f"\n⚠️  WARNING: Found {len(bm_references)} BMParliamentMember FK references:")
       for model_name, field_name in bm_references:
           print(f"   - {model_name}.{field_name}")
   else:
       print("✓ No BMParliamentMember FK references found")

   # 8. Code References Check
   print("\n8. CODE REFERENCES CHECK")
   print("-" * 70)

   import subprocess

   try:
       result = subprocess.run(
           ['grep', '-r', 'BMParliamentMember', '/Users/saidamenmambayao/apps/madaris-ms/src/apps', '--include=*.py'],
           capture_output=True,
           text=True
       )

       if result.returncode == 0:
           lines = result.stdout.strip().split('\n')
           # Filter out .bak files
           lines = [l for l in lines if '.bak' not in l]
           if lines:
               print(f"⚠️  WARNING: Found {len(lines)} BMParliamentMember references in code:")
               for line in lines[:5]:  # Show first 5
                   print(f"   {line}")
               if len(lines) > 5:
                   print(f"   ... and {len(lines) - 5} more")
           else:
               print("✓ No BMParliamentMember references in code")
       else:
           print("✓ No BMParliamentMember references found")
   except Exception as e:
       print(f"⚠️  Could not check code references: {e}")

   # 9. Template Files Check
   print("\n9. TEMPLATE FILES CHECK")
   print("-" * 70)

   template_files = [
       'constituents/student_list.html',
       'constituents/student_detail.html',
       'constituents/enroll_student.html',
       'constituents/change_student_status.html',
   ]

   for template in template_files:
       template_path = f'/Users/saidamenmambayao/apps/madaris-ms/src/apps/constituents/templates/{template}'
       if os.path.exists(template_path):
           print(f"✓ {template}")
       else:
           print(f"✗ MISSING: {template}")

   # 10. Summary
   print("\n" + "=" * 70)
   print("VERIFICATION SUMMARY")
   print("=" * 70)

   issues = []

   if plan:
       issues.append(f"{len(plan)} unapplied migrations")
   if missing_fields:
       issues.append(f"Missing model fields: {', '.join(missing_fields)}")
   if Student not in site._registry:
       issues.append("Student admin not registered")
   if bm_references:
       issues.append(f"{len(bm_references)} BMParliamentMember FK references")

   if len(issues) == 0:
       print("\n✓ PHASE 6 VERIFICATION PASSED")
       print("\nAll checks completed successfully.")
       print("Student Model Transition is complete.")
       sys.exit(0)
   else:
       print("\n⚠️  PHASE 6 VERIFICATION FAILED")
       print("\nIssues found:")
       for issue in issues:
           print(f"  - {issue}")
       print("\nPlease address these issues before marking Phase 6 as complete.")
       sys.exit(1)
   EOF
   chmod +x /Users/saidamenmambayao/apps/madaris-ms/scripts/verify_phase6_complete.py
   ```
2. Run comprehensive verification:
   ```bash
   cd /Users/saidamenmambayao/apps/madaris-ms
   python /Users/saidamenmambayao/apps/madaris-ms/scripts/verify_phase6_complete.py | tee /Users/saidamenmambayao/apps/madaris-ms/docs/docs-new/tasks-refactor/phase-06-student/PHASE6_VERIFICATION.txt
   ```
3. Run all student-related tests:
   ```bash
   # Run model tests
   python manage.py test apps.constituents.tests.test_models --verbosity=2

   # Run form tests
   python manage.py test apps.constituents.tests.test_forms --verbosity=2

   # Run view tests (if they exist)
   python manage.py test apps.constituents.tests.test_views --verbosity=2
   ```
4. Test admin interface manually:
   ```bash
   # Start development server
   python manage.py runserver 8000 &
   SERVER_PID=$!

   echo "Server started. Test the following:"
   echo "1. Admin login: http://localhost:8000/admin/"
   echo "2. Student list: http://localhost:8000/admin/constituents/student/"
   echo "3. Add student: http://localhost:8000/admin/constituents/student/add/"
   echo ""
   echo "Press Enter when done testing..."
   read

   # Stop server
   kill $SERVER_PID
   ```
5. Test public views:
   ```bash
   # Start server again for public view testing
   python manage.py runserver 8000 &
   SERVER_PID=$!

   echo "Test the following public views:"
   echo "1. Student list: http://localhost:8000/students/"
   echo "2. Enroll student: http://localhost:8000/students/enroll/"
   echo ""
   echo "Press Enter when done testing..."
   read

   # Stop server
   kill $SERVER_PID
   ```
6. Generate Phase 6 completion report:
   ```bash
   cat > /Users/saidamenmambayao/apps/madaris-ms/docs/docs-new/tasks-refactor/phase-06-student/PHASE6_COMPLETION_REPORT.md << 'EOF'
   # Phase 6 - Student Model Transition - Completion Report

   ## Date Completed
   $(date)

   ## Overview
   Phase 6 successfully transitioned the BMParliamentMember model to Student model,
   including all necessary migrations, updates, and new functionality.

   ## Tasks Completed
   - [x] task_061: Migration strategy planned
   - [x] task_062: Student model created (renamed from BMParliamentMember)
   - [x] task_063: Student-specific fields added
   - [x] task_064: Data migration script created
   - [x] task_065: Student migration executed
   - [x] task_066: Foreign key references updated
   - [x] task_067: Data integrity verified
   - [x] task_068: Student enrollment workflows created
   - [x] task_069: Student admin interface updated
   - [x] task_070: Student forms created
   - [x] task_071: Student templates created
   - [x] task_072: Phase 6 verification completed

   ## Deliverables

   ### Model Changes
   - BMParliamentMember → Student (model renamed)
   - Database table: constituents_student
   - Added fields: student_number, enrollment_status, current_grade_level
   - All existing data preserved

   ### Admin Interface
   - Enhanced list display with custom methods
   - Colored status badges
   - Bulk actions (enroll, graduate, export)
   - CSV export functionality
   - Custom filters with counts

   ### Forms
   - StudentEnrollmentForm
   - StudentSearchForm
   - QuickEnrollmentForm
   - StudentUpdateForm
   - StudentStatusChangeForm
   - BulkEnrollmentForm

   ### Templates
   - student_list.html
   - student_detail.html
   - enroll_student.html
   - change_student_status.html

   ### Workflows
   - Student enrollment process
   - Status transition validation
   - Student number auto-generation
   - Family information tracking

   ## Verification Results
   See: PHASE6_VERIFICATION.txt for detailed verification results

   ## Data Statistics
   - Total students: $(python manage.py shell -c "from apps.constituents.models import Student; print(Student.objects.count())")
   - Students with student_number: $(python manage.py shell -c "from apps.constituents.models import Student; print(Student.objects.exclude(student_number__isnull=True).count())")
   - Currently enrolled: $(python manage.py shell -c "from apps.constituents.models import Student; print(Student.objects.filter(enrollment_status='enrolled').count())")

   ## Migration Safety
   - All backups created and verified
   - Rollback procedures documented
   - Data integrity confirmed
   - No data loss

   ## Next Phase
   Ready to proceed to Phase 7: Academic Records

   ## Notes
   - Keep backups for 30 days
   - Monitor production for any issues
   - All BMParliamentMember references removed
   - Foreign keys updated successfully

   ---

   **Phase 6 Status:** COMPLETE ✓
   EOF
   ```
7. Update phase README:
   ```bash
   cat > /Users/saidamenmambayao/apps/madaris-ms/docs/docs-new/tasks-refactor/phase-06-student/README.md << 'EOF'
   # Phase 6 - Student Model Transition

   ## Status: COMPLETE ✓

   ## Completion Date: $(date +%Y-%m-%d)

   ## Tasks Completed: 12/12

   ### Overview
   This phase successfully transitioned the BMParliamentMember model to the Student model,
   including model renaming, data migration, enrollment management, and student profiles.

   ### Completed Tasks:
   1. ✅ task_061.txt - Migration strategy planned
   2. ✅ task_062.txt - Student model created (rename from BMParliamentMember)
   3. ✅ task_063.txt - Student-specific fields added
   4. ✅ task_064.txt - Data migration script created
   5. ✅ task_065.txt - Student migration executed
   6. ✅ task_066.txt - Foreign key references updated
   7. ✅ task_067.txt - Data integrity verified
   8. ✅ task_068.txt - Student enrollment workflows created
   9. ✅ task_069.txt - Student admin interface enhanced
   10. ✅ task_070.txt - Student forms created
   11. ✅ task_071.txt - Student templates created
   12. ✅ task_072.txt - Phase 6 verification completed

   ### Risk Level: HIGH (Successfully Mitigated)
   - Critical data migration completed successfully
   - All data preserved and verified
   - Rollback procedures tested and documented

   ### Key Achievements:
   - Model successfully renamed with zero data loss
   - All foreign key references updated
   - Enhanced admin interface with custom actions
   - Comprehensive enrollment workflows implemented
   - Student-specific forms and templates created
   - Data integrity verified

   ### Files Created/Modified:
   - Models: src/apps/constituents/models.py
   - Admin: src/apps/constituents/admin.py
   - Forms: src/apps/constituents/forms.py
   - Views: src/apps/constituents/views.py
   - Templates: 4 new templates
   - Migrations: 3 new migrations
   - Scripts: 3 verification scripts

   ### Documentation:
   - MIGRATION_STRATEGY.md
   - PHASE6_VERIFICATION.txt
   - PHASE6_COMPLETION_REPORT.md

   ### Next Phase:
   Ready to proceed to Phase 7: Academic Records

   ---

   **All tasks verified and complete. Phase 6 successful.**
   EOF
   ```
8. Final verification checklist:
   ```bash
   echo "FINAL VERIFICATION CHECKLIST"
   echo "============================"
   echo ""
   echo "[ ] All migrations applied"
   echo "[ ] Student model accessible"
   echo "[ ] No BMParliamentMember references"
   echo "[ ] Admin interface working"
   echo "[ ] Forms validated"
   echo "[ ] Templates rendering"
   echo "[ ] URLs configured"
   echo "[ ] Tests passing"
   echo "[ ] Data integrity verified"
   echo "[ ] Documentation complete"
   echo ""
   echo "Run: python scripts/verify_phase6_complete.py"
   ```

## Acceptance Criteria:
- All migrations applied successfully
- Student model fully functional
- All foreign key references updated
- Data integrity verified
- Admin interface working
- Forms validated and working
- Templates rendering correctly
- URLs routing properly
- No references to BMParliamentMember
- All tests passing
- Phase completion report generated

## Files Modified:
- `scripts/verify_phase6_complete.py`
- `docs/docs-new/tasks-refactor/phase-06-student/PHASE6_VERIFICATION.txt`
- `docs/docs-new/tasks-refactor/phase-06-student/PHASE6_COMPLETION_REPORT.md`
- `docs/docs-new/tasks-refactor/phase-06-student/README.md (updated)`

## Important Notes:
- This is the final verification task for Phase 6
- Must pass all checks before proceeding to Phase 7
- Comprehensive testing of all components
- Documentation of completion required
- Estimate: 1 hour

## Success Criteria:
All verification checks must pass:
- ✓ All migrations applied
- ✓ Student model functional
- ✓ No BMParliamentMember references
- ✓ Admin interface working
- ✓ Forms validated
- ✓ Templates rendering
- ✓ URLs configured
- ✓ Data integrity confirmed
- ✓ All tests passing

## If Verification Fails:
1. Review PHASE6_VERIFICATION.txt for specific failures
2. Address each issue systematically
3. Re-run verification
4. Update relevant task files
5. Document any deviations from plan

## Phase 6 Completion:
Once this task is complete and all checks pass:
1. Mark all Phase 6 tasks as done
2. Update main project status
3. Backup all Phase 6 work
4. Proceed to Phase 7 planning

# Test Strategy:
1. Verify migration file syntax with `python manage.py sqlmigrate`
2. Test forward migration on staging database
3. Test reverse migration to ensure rollback works
4. Verify no data loss during migration
5. Run full test suite to catch regressions
6. Run migrations and verify schema changes
7. Create test instances to verify new fields
8. Test admin interface with new fields
9. Verify backward compatibility with existing data
10. Run test suite with `python manage.py test`
11. Verify test coverage meets requirements
12. Check for any failing tests
13. Verify test assertions are correct