{# src/templates/core/bulk_member_registration.html #}
{% extends 'base/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Bulk Member Registration - #FahanieCares{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 100vh;
        padding: 1.5rem 0;
    }

    .dashboard-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 2rem 2.5rem;
        margin-bottom: 2rem;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(16, 185, 129, 0.15);
        position: relative;
        overflow: hidden;
    }

    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 120px;
        height: 120px;
        background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
        border-radius: 50%;
        transform: translate(40%, -40%);
    }

    .dashboard-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        z-index: 2;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .dashboard-header h1 {
        color: white;
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .dashboard-header p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.125rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .header-icon {
        width: 3rem;
        height: 3rem;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .btn {
        padding: 0.75rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.875rem;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        min-height: 48px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(34, 197, 94, 0.4);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    .form-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        border: 1px solid #e5e7eb;
        margin-bottom: 2rem;
    }

    .form-header {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 1.5rem 2rem;
        border-bottom: 2px solid #10b981;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .form-header h3 {
        color: #1f2937;
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-icon {
        width: 2.25rem;
        height: 2.25rem;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .form-content {
        padding: 2rem;
    }

    .registrant-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
        margin-bottom: 1.5rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .registrant-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    .registrant-header {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .registrant-title {
        color: #1f2937;
        font-size: 1.125rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .registrant-number {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .delete-registrant {
        background: #ef4444;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .delete-registrant:hover {
        background: #dc2626;
        transform: translateY(-1px);
    }

    .registrant-content {
        padding: 1.5rem;
    }

    .section-title {
        color: #1f2937;
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-icon {
        width: 1.25rem;
        height: 1.25rem;
        color: #10b981;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        color: #374151;
        font-weight: 500;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .form-label-required::after {
        content: '*';
        color: #ef4444;
        margin-left: 0.25rem;
    }

    .form-control {
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: white;
    }

    .form-control:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .form-control.error {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    .form-control-icon {
        padding-left: 2.5rem;
        background-position: left 0.75rem center;
        background-repeat: no-repeat;
        background-size: 1rem;
    }

    .error-message {
        color: #ef4444;
        font-size: 0.75rem;
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .help-text {
        color: #6b7280;
        font-size: 0.75rem;
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .help-text::before {
        content: 'ðŸ’¡';
        font-size: 0.875rem;
    }

    .instructions-card {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border: 1px solid #bfdbfe;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .instructions-title {
        color: #1e40af;
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .instructions-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .instructions-item {
        color: #1e40af;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .instructions-item::before {
        content: 'âœ“';
        color: #10b981;
        font-weight: bold;
        margin-top: 0.125rem;
        flex-shrink: 0;
    }

    .form-actions {
        background: #f9fafb;
        padding: 1.5rem 2rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
    }

    .add-registrant-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .add-registrant-btn:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-1px);
    }

    .submit-btn {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .submit-btn:hover {
        background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        transform: translateY(-1px);
    }

    .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .alert {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .alert-info {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border: 1px solid #93c5fd;
        color: #1e40af;
    }

    .alert-warning {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 1px solid #f59e0b;
        color: #92400e;
    }

    .alert-error {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border: 1px solid #f87171;
        color: #991b1b;
    }

    .alert-icon {
        width: 1.25rem;
        height: 1.25rem;
        margin-top: 0.125rem;
        flex-shrink: 0;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .loading-spinner {
        width: 3rem;
        height: 3rem;
        border: 3px solid #e5e7eb;
        border-top: 3px solid #10b981;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        color: #374151;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .loading-subtext {
        color: #6b7280;
        font-size: 0.875rem;
    }

    .success-card {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border: 1px solid #a7f3d0;
        border-radius: 12px;
        padding: 2rem;
        margin-top: 2rem;
        text-align: center;
    }

    .success-icon {
        width: 4rem;
        height: 4rem;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        margin: 0 auto 1rem;
    }

    .success-title {
        color: #065f46;
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .success-text {
        color: #047857;
        font-size: 1rem;
        margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
        .dashboard-header h1 {
            font-size: 2rem;
        }

        .dashboard-header p {
            font-size: 1rem;
        }

        .action-buttons {
            flex-direction: column;
            width: 100%;
        }

        .btn {
            width: 100%;
        }

        .form-content {
            padding: 1.5rem;
        }

        .form-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .form-actions {
            flex-direction: column;
        }

        .registrant-header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container mx-auto px-4 max-w-6xl">
        <!-- Header Section -->
        <div class="dashboard-header">
            <div class="dashboard-header-content">
                <div class="header-left">
                    <div class="header-icon">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1>Bulk Member Registration</h1>
                        <p>
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Efficiently register multiple #FahanieCares members at once
                        </p>
                    </div>
                </div>
                <div class="action-buttons">
                    <a href="{% url 'database_registrants' %}" class="btn btn-success">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Back to Database
                    </a>
                </div>
            </div>
        </div>

        <!-- Instructions Card -->
        <div class="instructions-card">
            <div class="instructions-title">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                How to Use Bulk Member Registration
            </div>
            <ul class="instructions-list">
                <li class="instructions-item">Fill out the personal information for each member (name, age, gender)</li>
                <li class="instructions-item">Add contact details (email and phone number)</li>
                <li class="instructions-item">Specify location information (province, municipality, barangay)</li>
                <li class="instructions-item">Add voter address information and other details</li>
                <li class="instructions-item">Click "Add Another Registrant" to register multiple members</li>
                <li class="instructions-item">Click "Register All Members" to complete the process</li>
            </ul>
        </div>

        <!-- Main Form -->
        <div class="form-card">
            <div class="form-header">
                <div class="form-icon">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <h3>Member Registration Forms</h3>
            </div>

            <form method="post" enctype="multipart/form-data" id="bulk-registration-form">
                {% csrf_token %}

                <div class="form-content">
                    <!-- Alert Messages -->
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'warning' %}alert-warning{% else %}alert-info{% endif %}">
                                <svg class="alert-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    {% if message.tags == 'error' %}
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    {% elif message.tags == 'warning' %}
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    {% else %}
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    {% endif %}
                                </svg>
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}

                    <!-- Management form fields -->
                    <div id="management-form-fields" style="display: none;">
                        {{ formset.management_form }}
                    </div>

                    <!-- Formset Container -->
                    <div id="formset-container" class="space-y-4">
                        {% for form in formset %}
                            <div class="registrant-card" id="form-{{ forloop.counter0 }}">
                                <div class="registrant-header">
                                    <div class="registrant-title">
                                        <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        Registrant #<span class="registrant-number">{{ forloop.counter }}</span>
                                    </div>
                                    {% if formset.can_delete %}
                                        <button type="button" class="delete-registrant" data-form-id="{{ forloop.counter0 }}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                            Delete
                                        </button>
                                    {% endif %}
                                </div>

                                <div class="registrant-content">
                                    {% if form.non_field_errors %}
                                        <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-4">
                                            <div class="flex">
                                                <div class="flex-shrink-0">
                                                    <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                                    </svg>
                                                </div>
                                                <div class="ml-3">
                                                    {% for error in form.non_field_errors %}
                                                        <p class="text-sm">{{ error }}</p>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}

                                    <!-- Personal Information Section -->
                                    <div class="mb-6">
                                        <div class="section-title">
                                            <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                            </svg>
                                            Personal Information
                                        </div>
                                        <div class="form-grid">
                                            {% for field in form %}
                                                {% if field.name in 'first_name last_name middle_name age sex' %}
                                                    <div class="form-group">
                                                        <label for="{{ field.id_for_label }}" class="form-label {% if field.field.required %}form-label-required{% endif %}">
                                                            {{ field.label }}
                                                        </label>
                                                        <div class="relative">
                                                            {{ field|add_class:"form-control" }}
                                                            {% if field.name == 'first_name' or field.name == 'last_name' or field.name == 'middle_name' %}
                                                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                                    </svg>
                                                                </div>
                                                            {% elif field.name == 'age' %}
                                                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                                    </svg>
                                                                </div>
                                                            {% elif field.name == 'sex' %}
                                                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                    </svg>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        {% if field.help_text %}
                                                            <div class="help-text">{{ field.help_text }}</div>
                                                        {% endif %}
                                                        {% for error in field.errors %}
                                                            <div class="error-message">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <!-- Contact Information Section -->
                                    <div class="mb-6">
                                        <div class="section-title">
                                            <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                            </svg>
                                            Contact Information
                                        </div>
                                        <div class="form-grid">
                                            {% for field in form %}
                                                {% if field.name in 'contact_number email' %}
                                                    <div class="form-group">
                                                        <label for="{{ field.id_for_label }}" class="form-label {% if field.field.required %}form-label-required{% endif %}">
                                                            {{ field.label }}
                                                        </label>
                                                        <div class="relative">
                                                            {{ field|add_class:"form-control" }}
                                                            {% if field.name == 'contact_number' %}
                                                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                                                    </svg>
                                                                </div>
                                                            {% elif field.name == 'email' %}
                                                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                                                    </svg>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        {% if field.help_text %}
                                                            <div class="help-text">{{ field.help_text }}</div>
                                                        {% endif %}
                                                        {% for error in field.errors %}
                                                            <div class="error-message">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <!-- Location Information Section -->
                                    <div class="mb-6">
                                        <div class="section-title">
                                            <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                            Location Information
                                        </div>
                                        <div class="form-grid">
                                            {% for field in form %}
                                                {% if field.name == 'address_province' %}
                                                    <div class="form-group">
                                                        <label for="{{ field.id_for_label }}" class="form-label form-label-required">
                                                            Province
                                                        </label>
                                                        <div class="relative">
                                                            {{ field|add_class:"form-control" }}
                                                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                                </svg>
                                                            </div>
                                                        </div>
                                                        {% for error in field.errors %}
                                                            <div class="error-message">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                            {% for field in form %}
                                                {% if field.name == 'address_municipality' %}
                                                    <div class="form-group">
                                                        <label for="{{ field.id_for_label }}" class="form-label form-label-required">
                                                            Municipality
                                                        </label>
                                                        <div class="relative">
                                                            {{ field|add_class:"form-control" }}
                                                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                                </svg>
                                                            </div>
                                                        </div>
                                                        {% for error in field.errors %}
                                                            <div class="error-message">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                            {% for field in form %}
                                                {% if field.name == 'address_barangay' %}
                                                    <div class="form-group">
                                                        <label for="{{ field.id_for_label }}" class="form-label form-label-required">
                                                            Barangay
                                                        </label>
                                                        <div class="relative">
                                                            {{ field|add_class:"form-control" }}
                                                        </div>
                                                        {% for error in field.errors %}
                                                            <div class="error-message">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <!-- Voter Address Information Section -->
                                    <div class="mb-6">
                                        <div class="section-title">
                                            <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            Voter Address Information
                                        </div>
                                        <div class="form-grid">
                                            {% for field in form %}
                                                {% if field.name == 'voter_address_province' %}
                                                    <div class="form-group">
                                                        <label for="{{ field.id_for_label }}" class="form-label form-label-required">
                                                            Province
                                                        </label>
                                                        <div class="relative">
                                                            {{ field|add_class:"form-control" }}
                                                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                                </svg>
                                                            </div>
                                                        </div>
                                                        {% for error in field.errors %}
                                                            <div class="error-message">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                            {% for field in form %}
                                                {% if field.name == 'voter_address_municipality' %}
                                                    <div class="form-group">
                                                        <label for="{{ field.id_for_label }}" class="form-label form-label-required">
                                                            Municipality
                                                        </label>
                                                        <div class="relative">
                                                            {{ field|add_class:"form-control" }}
                                                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                                </svg>
                                                            </div>
                                                        </div>
                                                        {% for error in field.errors %}
                                                            <div class="error-message">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                            {% for field in form %}
                                                {% if field.name == 'voter_address_barangay' %}
                                                    <div class="form-group">
                                                        <label for="{{ field.id_for_label }}" class="form-label form-label-required">
                                                            Barangay
                                                        </label>
                                                        <div class="relative">
                                                            {{ field|add_class:"form-control" }}
                                                        </div>
                                                        {% for error in field.errors %}
                                                            <div class="error-message">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <!-- Other Details Section -->
                                    <div class="mb-6">
                                        <div class="section-title">
                                            <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0V6a2 2 0 012 2h4a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h4a2 2 0 012-2z"></path>
                                            </svg>
                                            Other Details
                                        </div>
                                        <div class="form-grid">
                                            {% for field in form %}
                                                {% if field.name in 'sector highest_education school_graduated eligibility status voter_id_photo' %}
                                                    <div class="form-group">
                                                        <label for="{{ field.id_for_label }}" class="form-label {% if field.field.required %}form-label-required{% endif %}">
                                                            {{ field.label }}
                                                        </label>
                                                        <div class="relative">
                                                            {{ field|add_class:"form-control" }}
                                                            {% if field.name == 'sector' %}
                                                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                                    </svg>
                                                                </div>
                                                            {% elif field.name == 'highest_education' %}
                                                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                                    </svg>
                                                                </div>
                                                            {% elif field.name == 'status' %}
                                                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                                    </svg>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        {% if field.help_text %}
                                                            <div class="help-text">{{ field.help_text }}</div>
                                                        {% endif %}
                                                        {% for error in field.errors %}
                                                            <div class="error-message">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" id="add-form" class="add-registrant-btn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                            </svg>
                            Add Another Registrant
                        </button>
                        <button type="submit" class="submit-btn" id="submit-btn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            Register All Members
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Success Message -->
        {% if registered_members_info %}
            <div class="success-card">
                <div class="success-icon">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h2 class="success-title">Registration Successful!</h2>
                <p class="success-text">The following members have been successfully registered in the #FahanieCares system.</p>

                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Member Login Credentials</h3>
                    <p class="text-gray-600 mb-4">Please securely communicate these credentials to the registered members:</p>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead>
                                <tr class="bg-gray-50 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">
                                    <th class="py-3 px-4 border-b">Name</th>
                                    <th class="py-3 px-4 border-b">Username</th>
                                    <th class="py-3 px-4 border-b">Password</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member in registered_members_info %}
                                <tr class="hover:bg-gray-50">
                                    <td class="py-3 px-4 border-b text-gray-800">{{ member.first_name }} {{ member.last_name }}</td>
                                    <td class="py-3 px-4 border-b text-gray-800 font-mono text-sm">{{ member.username }}</td>
                                    <td class="py-3 px-4 border-b text-gray-800 font-mono text-sm">{{ member.password }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm text-yellow-800">
                            <strong>Security Note:</strong> Please advise members to change their password after their first login for security purposes.
                        </p>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text">Registering Members...</div>
        <div class="loading-subtext">Please wait while we process your request</div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Province to Municipality mapping
    const provinceMunicipalityMap = {
        'Maguindanao del Sur': [
            'Ampatuan', 'Buluan', 'Datu Abdullah Sangki', 'Datu Anggal Midtimbang', 'Datu Hoffer Ampatuan', 'Datu Montawal', 'Datu Paglas', 'Datu Piang', 'Datu Salibo', 'Datu Saudi Ampatuan', 'Datu Unsay', 'General Salipada K. Pendatun', 'Guindulungan', 'Mamasapano', 'Mangudadatu', 'Pagalungan', 'Paglat', 'Pandag', 'Rajah Buayan', 'Shariff Aguak', 'Shariff Saydona Mustapha', 'South Upi', 'Sultan sa Barongis', 'Talayan'
        ],
        'Maguindanao del Norte': [
            'Barira', 'Buldon', 'Datu Blah Sinsuat', 'Datu Odin Sinsuat', 'Kabuntalan', 'Matanog', 'Northern Kabuntalan', 'Parang', 'North Upi', 'Sultan Kudarat', 'Sultan Mastura', 'Talitay'
        ],
        'Cotabato City': [
            'Cotabato City'
        ],
        'Special Geographic Areas (SGA)': [
            'Pahamuddin', 'Kadayangan', 'Nabalawag', 'Old Kaabakan', 'Kapalawan', 'Malidegao', 'Tugunan', 'Ligawasan'
        ]
    };

    function updateMunicipalityOptions(provinceSelect, municipalitySelect) {
        const selectedProvince = provinceSelect.value;
        const municipalities = provinceMunicipalityMap[selectedProvince] || [];

        // Save current selection
        const currentValue = municipalitySelect.value;

        // Clear existing options except first
        while (municipalitySelect.options.length > 1) {
            municipalitySelect.remove(1);
        }

        // Add new options
        municipalities.forEach(function(muni) {
            const option = document.createElement('option');
            option.value = muni;
            option.textContent = muni;
            municipalitySelect.appendChild(option);
        });

        // Restore selection if valid
        if (currentValue && municipalities.includes(currentValue)) {
            municipalitySelect.value = currentValue;
        } else {
            municipalitySelect.value = '';
        }
    }

    function setupProvinceMunicipalityPair(formContainer, provinceName, municipalityName) {
        const provinceSelect = formContainer.querySelector(`select[name$='${provinceName}']`);
        const municipalitySelect = formContainer.querySelector(`select[name$='${municipalityName}']`);

        if (!provinceSelect || !municipalitySelect) return;

        // Save current selection
        if (municipalitySelect.value) {
            municipalitySelect.dataset.selected = municipalitySelect.value;
        }

        provinceSelect.addEventListener('change', function() {
            updateMunicipalityOptions(provinceSelect, municipalitySelect);
        });

        // Update on page load if province is selected
        if (provinceSelect.value) {
            updateMunicipalityOptions(provinceSelect, municipalitySelect);
        }
    }

    // Setup existing forms
    document.querySelectorAll('#formset-container > div').forEach(function(formContainer) {
        setupProvinceMunicipalityPair(formContainer, 'address_province', 'address_municipality');
        setupProvinceMunicipalityPair(formContainer, 'voter_address_province', 'voter_address_municipality');
    });

    // Formset management
    const formsetContainer = document.getElementById('formset-container');
    const addButton = document.getElementById('add-form');
    const totalForms = document.querySelector('#id_form-TOTAL_FORMS');
    const initialForms = document.querySelector('#id_form-INITIAL_FORMS');
    const maxForms = document.querySelector('#id_form-MAX_NUM_FORMS');
    const form = document.getElementById('bulk-registration-form');
    const submitBtn = document.getElementById('submit-btn');
    const loadingOverlay = document.getElementById('loading-overlay');

    let formIdx = parseInt(totalForms.value);

    addButton.addEventListener('click', function() {
        const newForm = formsetContainer.children[0].cloneNode(true);
        newForm.id = `form-${formIdx}`;
        newForm.querySelector('.registrant-number').textContent = formIdx + 1;

        // Clear input values and update names/ids
        newForm.querySelectorAll('input, select, textarea').forEach(input => {
            if (/form-(TOTAL_FORMS|INITIAL_FORMS|MAX_NUM_FORMS)/.test(input.name || '')) {
                return;
            }
            if (input.type !== 'hidden') {
                input.value = '';
            }
            input.name = input.name.replace(/form-\d+/, `form-${formIdx}`);
            input.id = input.id.replace(/id_form-\d+/, `id_form-${formIdx}`);
        });

        // Update DELETE checkbox
        const deleteCheckbox = newForm.querySelector(`[name="form-${formIdx-1}-DELETE"]`);
        if (deleteCheckbox) {
            deleteCheckbox.name = `form-${formIdx}-DELETE`;
            deleteCheckbox.id = `id_form-${formIdx}-DELETE`;
            deleteCheckbox.checked = false;
        }

        // Update delete button
        const deleteButton = newForm.querySelector('.delete-registrant');
        if (deleteButton) {
            deleteButton.dataset.formId = formIdx;
            deleteButton.addEventListener('click', deleteForm);
        }

        formsetContainer.appendChild(newForm);
        totalForms.value = formIdx + 1;
        formIdx++;

        // Setup province-municipality logic for new form
        setupProvinceMunicipalityPair(newForm, 'address_province', 'address_municipality');
        setupProvinceMunicipalityPair(newForm, 'voter_address_province', 'voter_address_municipality');
    });

    function deleteForm(event) {
        const button = event.target;
        const formId = button.dataset.formId;
        const formToDelete = document.getElementById(`form-${formId}`);

        if (formToDelete) {
            const deleteCheckbox = formToDelete.querySelector(`#id_form-${formId}-DELETE`);
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
            }
            formToDelete.style.display = 'none';
        }
    }

    // Attach delete event listeners
    formsetContainer.querySelectorAll('.delete-registrant').forEach(button => {
        button.addEventListener('click', deleteForm);
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        loadingOverlay.style.display = 'flex';
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Processing...';
    });
});
</script>
{% endblock %}
