{% extends "base/base.html" %}
{% load static %}

{% block title %}Member Analytics Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-4xl font-bold text-gray-900 mb-2">Analytics Dashboard</h1>
                <p class="text-lg text-gray-600">Member insights and statistics overview</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <div class="text-sm text-gray-500">Last updated</div>
                    <div class="text-sm font-medium text-gray-900" id="lastUpdated">Just now</div>
                </div>
                <button onclick="window.location.reload()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-xl shadow-sm mb-8 border border-gray-100">
        <div class="flex items-center mb-4">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                    <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                </div>
                <h2 class="text-xl font-semibold text-gray-900">Data Filters</h2>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="relative">
                <label for="provinceFilter" class="block text-sm font-medium text-gray-700 mb-2">Province</label>
                <div class="relative">
                    <select id="provinceFilter" class="block w-full pl-4 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 sm:text-sm rounded-lg border-2 bg-white shadow-sm appearance-none">
                        <option>All</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="relative">
                <label for="municipalityFilter" class="block text-sm font-medium text-gray-700 mb-2">Municipality</label>
                <div class="relative">
                    <select id="municipalityFilter" class="block w-full pl-4 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 sm:text-sm rounded-lg border-2 bg-white shadow-sm appearance-none">
                        <option>All</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="relative">
                <label for="sectorFilter" class="block text-sm font-medium text-gray-700 mb-2">Sector</label>
                <div class="relative">
                    <select id="sectorFilter" class="block w-full pl-4 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 sm:text-sm rounded-lg border-2 bg-white shadow-sm appearance-none">
                        <option>All</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-medium text-gray-600 mb-1">Total Members</h2>
                    <p id="totalMembers" class="text-4xl font-bold text-gray-900">0</p>
                    <p class="text-sm text-gray-500 mt-1">Registered users</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-medium text-gray-600 mb-1">New This Month</h2>
                    <p id="newThisMonth" class="text-4xl font-bold text-gray-900">0</p>
                    <p class="text-sm text-gray-500 mt-1">Recent registrations</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-medium text-gray-600 mb-1">Active Rate</h2>
                    <p id="activePercentage" class="text-4xl font-bold text-gray-900">0%</p>
                    <p class="text-sm text-gray-500 mt-1">Approved members</p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="space-y-8">
        <!-- Primary Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Registration Trend -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Registration Trend</h2>
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                </div>
                <div class="relative" style="height: 300px;">
                    <canvas id="registrationTrendChart"></canvas>
                    <div id="registrationTrendLoading" class="absolute inset-0 flex items-center justify-center bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                            <span class="text-gray-600">Loading chart...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gender Distribution -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Gender Distribution</h2>
                    <div class="w-8 h-8 bg-pink-100 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="relative" style="height: 300px;">
                    <canvas id="genderChart"></canvas>
                    <div id="genderChartLoading" class="absolute inset-0 flex items-center justify-center bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                            <span class="text-gray-600">Loading chart...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Membership Status -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Membership Status</h2>
                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="relative" style="height: 300px;">
                    <canvas id="statusChart"></canvas>
                    <div id="statusChartLoading" class="absolute inset-0 flex items-center justify-center bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                            <span class="text-gray-600">Loading chart...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Age Groups -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Age Groups</h2>
                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                </div>
                <div class="relative" style="height: 300px;">
                    <canvas id="ageChart"></canvas>
                    <div id="ageChartLoading" class="absolute inset-0 flex items-center justify-center bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                            <span class="text-gray-600">Loading chart...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Full Width Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Sector Analysis -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Sector Analysis</h2>
                    <div class="flex items-center space-x-3">
                        <!-- Chart Display Toggle -->
                        <div class="flex items-center space-x-2 bg-gray-50 rounded-lg p-1">
                            <button id="sectorChartToggleNumbers" class="px-3 py-1 text-xs font-medium text-gray-700 bg-white rounded-md shadow-sm border border-gray-200 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
                                <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                                </svg>
                                Numbers
                            </button>
                            <button id="sectorChartToggleColors" class="px-3 py-1 text-xs font-medium text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
                                <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"></path>
                                </svg>
                                Colors Only
                            </button>
                        </div>
                        <div class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="relative" style="height: 400px;">
                    <canvas id="sectorChart"></canvas>
                    <div id="sectorChartLoading" class="absolute inset-0 flex items-center justify-center bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                            <span class="text-gray-600">Loading chart...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sector Status Overview -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Sector Status Overview</h2>
                    <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                </div>
                <div class="relative" style="height: 400px; overflow-y: auto;">
                    <canvas id="sectorStatusRaceChart"></canvas>
                    <div id="sectorStatusChartLoading" class="absolute inset-0 flex items-center justify-center bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                            <span class="text-gray-600">Loading chart...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ provinces|json_script:"provinces-data" }}
{{ municipalities|json_script:"municipalities-data" }}
{{ sectors|json_script:"sectors-data" }}
{{ sector_display_names|json_script:"sector-display-names-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM Content Loaded - Analytics Dashboard');

    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded!');
        return;
    }

    const genderChartElement = document.getElementById('genderChart');
    const ageChartElement = document.getElementById('ageChart');
    const statusChartElement = document.getElementById('statusChart');
    const sectorChartElement = document.getElementById('sectorChart');
    const registrationTrendChartElement = document.getElementById('registrationTrendChart');
    const sectorStatusRaceChartElement = document.getElementById('sectorStatusRaceChart');

    console.log('Chart elements found:', {
        genderChart: !!genderChartElement,
        ageChart: !!ageChartElement,
        statusChart: !!statusChartElement,
        sectorChart: !!sectorChartElement,
        registrationTrendChart: !!registrationTrendChartElement,
        sectorStatusRaceChart: !!sectorStatusRaceChartElement
    });

    if (!genderChartElement) {
        console.error('Chart elements not found!');
        return;
    }

    const genderChartCtx = genderChartElement.getContext('2d');
    const ageChartCtx = ageChartElement.getContext('2d');
    const statusChartCtx = statusChartElement.getContext('2d');
    const sectorChartCtx = sectorChartElement.getContext('2d');
    const registrationTrendChartCtx = registrationTrendChartElement.getContext('2d');
    const sectorStatusRaceChartCtx = sectorStatusRaceChartElement.getContext('2d');

    let genderChart, ageChart, statusChart, sectorChart, registrationTrendChart, sectorStatusRaceChart;

    // Register the datalabels plugin only for the specific chart where it's needed
    Chart.register(ChartDataLabels);

    function populateFilters() {
        // Populate province filter
        const provincesData = JSON.parse(document.getElementById('provinces-data').textContent);
        const provinceSelect = document.getElementById('provinceFilter');
        provincesData.forEach(province => {
            const option = document.createElement('option');
            option.value = province;
            option.textContent = province;
            provinceSelect.appendChild(option);
        });

        // Populate municipality filter
        const municipalitiesData = JSON.parse(document.getElementById('municipalities-data').textContent);
        const municipalitySelect = document.getElementById('municipalityFilter');
        municipalitiesData.forEach(municipality => {
            const option = document.createElement('option');
            option.value = municipality;
            option.textContent = municipality;
            municipalitySelect.appendChild(option);
        });

        // Populate sector filter
        const sectorsData = JSON.parse(document.getElementById('sectors-data').textContent);
        const sectorDisplayNamesData = JSON.parse(document.getElementById('sector-display-names-data').textContent);
        const sectorSelect = document.getElementById('sectorFilter');

        sectorsData.forEach((sector, index) => {
            const option = document.createElement('option');
            option.value = sector;
            option.textContent = sectorDisplayNamesData[index] || sector;
            sectorSelect.appendChild(option);
        });
    }

    function createCharts() {
        populateFilters();
        fetchData();
    }

    function fetchData() {
        console.log('Fetching data...');
        const province = document.getElementById('provinceFilter').value;
        const municipality = document.getElementById('municipalityFilter').value;
        const sector = document.getElementById('sectorFilter').value;

        let url = new URL(window.location.href);
        let params = new URLSearchParams();
        if (province !== 'All') params.append('province', province);
        if (municipality !== 'All') params.append('municipality', municipality);
        if (sector !== 'All') params.append('sector', sector);

        const apiUrl = `/en/analytics/api/summary-data/?${params.toString()}`;
        console.log('API URL:', apiUrl);

        fetch(apiUrl)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Summary data received:', data);
                document.getElementById('totalMembers').textContent = data.total_members;
                document.getElementById('newThisMonth').textContent = data.new_this_month;
                document.getElementById('activePercentage').textContent = `${data.active_percentage}%`;

                // Update last updated timestamp
                const now = new Date();
                document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
            })
            .catch(error => {
                console.error('Error fetching summary data:', error);
            });

        fetch(`/en/analytics/api/gender-distribution/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                console.log('Gender data received:', data);
                updateGenderChart(data);
            });

        fetch(`/en/analytics/api/age-distribution/?${params.toString()}`)
            .then(response => response.json())
            .then(data => updateAgeChart(data));

        fetch(`/en/analytics/api/membership-status-distribution/?${params.toString()}`)
            .then(response => response.json())
            .then(data => updateStatusChart(data));
        
        fetch(`/en/analytics/api/sector-distribution/?${params.toString()}`)
            .then(response => {
                console.log('Sector distribution response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Sector distribution data received:', data);
                if (data && data.length > 0) {
                    updateSectorChart(data);
                } else {
                    console.warn('No sector distribution data received');
                    // Hide loading even if no data
                    document.getElementById('sectorChartLoading').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error fetching sector distribution:', error);
                // Hide loading even on error
                document.getElementById('sectorChartLoading').style.display = 'none';
            });

        fetch(`/en/analytics/api/registration-trend/?${params.toString()}`)
            .then(response => response.json())
            .then(data => updateRegistrationTrendChart(data));

        fetch(`/en/analytics/api/sector-status-distribution/?${params.toString()}`)
            .then(response => response.json())
            .then(data => updateSectorStatusRaceChart(data));
    }

    // Initialize charts on page load
    createCharts();

    // Add event listeners for filters
    document.getElementById('provinceFilter').addEventListener('change', fetchData);
    document.getElementById('municipalityFilter').addEventListener('change', fetchData);
    document.getElementById('sectorFilter').addEventListener('change', fetchData);

    // Add event listeners for sector chart display toggles
    let showDataLabels = true; // Default to showing numbers

    document.getElementById('sectorChartToggleNumbers').addEventListener('click', function() {
        showDataLabels = true;
        updateSectorChartDisplay();
        updateToggleButtons();
    });

    document.getElementById('sectorChartToggleColors').addEventListener('click', function() {
        showDataLabels = false;
        updateSectorChartDisplay();
        updateToggleButtons();
    });

    function updateToggleButtons() {
        const numbersBtn = document.getElementById('sectorChartToggleNumbers');
        const colorsBtn = document.getElementById('sectorChartToggleColors');

        if (showDataLabels) {
            numbersBtn.className = 'px-3 py-1 text-xs font-medium text-gray-700 bg-white rounded-md shadow-sm border border-gray-200 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors';
            colorsBtn.className = 'px-3 py-1 text-xs font-medium text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors';
        } else {
            numbersBtn.className = 'px-3 py-1 text-xs font-medium text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors';
            colorsBtn.className = 'px-3 py-1 text-xs font-medium text-gray-700 bg-white rounded-md shadow-sm border border-gray-200 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors';
        }
    }

    function updateSectorChartDisplay() {
        if (!sectorChart) return;

        // Update the chart options to show/hide data labels
        sectorChart.options.plugins.datalabels = showDataLabels ? {
            display: true,
            color: '#ffffff',
            font: {
                size: 11,
                weight: 'bold'
            },
            formatter: function(value) {
                return value > 0 ? value : '';
            },
            anchor: 'center',
            align: 'center'
        } : {
            display: false
        };

        // Update the chart
        sectorChart.update();
    }

    function updateGenderChart(data) {
        console.log('Updating gender chart with data:', data);
        const labels = data.map(item => item.sex);
        const counts = data.map(item => item.count);

        if (genderChart) genderChart.destroy();
        genderChart = new Chart(genderChartCtx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Gender Distribution',
                    data: counts,
                    backgroundColor: ['#EC4899', '#3B82F6', '#F59E0B', '#10B981', '#8B5CF6'],
                    borderWidth: 2,
                    borderColor: '#ffffff',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#e5e7eb',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed * 100) / total).toFixed(1);
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Hide loading indicator
        document.getElementById('genderChartLoading').style.display = 'none';
    }

    function showLoadingStates() {
        // Show all loading indicators
        const loadingElements = [
            'registrationTrendLoading',
            'genderChartLoading',
            'statusChartLoading',
            'ageChartLoading',
            'sectorChartLoading',
            'sectorStatusChartLoading'
        ];

        loadingElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.display = 'flex';
        });
    }

    function hideLoadingStates() {
        // Hide all loading indicators
        const loadingElements = [
            'registrationTrendLoading',
            'genderChartLoading',
            'statusChartLoading',
            'ageChartLoading',
            'sectorChartLoading',
            'sectorStatusChartLoading'
        ];

        loadingElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.display = 'none';
        });
    }

    function updateAgeChart(data) {
        console.log('Updating age chart with data:', data);
        const labels = data.map(item => item.age);
        const counts = data.map(item => item.count);

        if (ageChart) ageChart.destroy();
        ageChart = new Chart(ageChartCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Age Groups',
                    data: counts,
                    backgroundColor: '#10B981',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Hide loading indicator
        document.getElementById('ageChartLoading').style.display = 'none';
    }

    function updateStatusChart(data) {
        console.log('Updating status chart with data:', data);
        const labels = data.map(item => item.status);
        const counts = data.map(item => item.count);

        const colorMap = {
            'approved': '#10B981', // Green
            'incomplete': '#EF4444', // Red
            'pending': '#FBBF24', // Yellow
            'archived': '#6B7280', // Grey for archived or other
        };

        const backgroundColors = labels.map(label => colorMap[label] || '#6B7280'); // Default to grey if status not in map

        if (statusChart) statusChart.destroy();
        statusChart = new Chart(statusChartCtx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Membership Status',
                    data: counts,
                    backgroundColor: backgroundColors,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#e5e7eb',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true
                    }
                }
            }
        });

        // Hide loading indicator
        document.getElementById('statusChartLoading').style.display = 'none';
    }

    function updateSectorChart(data) {
        console.log('Updating sector race chart with data:', data);

        // Fetch sector-status distribution data for the race chart
        const province = document.getElementById('provinceFilter').value;
        const municipality = document.getElementById('municipalityFilter').value;
        const sector = document.getElementById('sectorFilter').value;

        let params = new URLSearchParams();
        if (province !== 'All') params.append('province', province);
        if (municipality !== 'All') params.append('municipality', municipality);
        if (sector !== 'All') params.append('sector', sector);

        fetch(`/en/analytics/api/sector-status-distribution/?${params.toString()}`)
            .then(response => response.json())
            .then(sectorStatusData => {
                console.log('Sector status data for race chart:', sectorStatusData);
                createSectorRaceChart(sectorStatusData);
            })
            .catch(error => {
                console.error('Error fetching sector status data:', error);
                // Fallback to original chart if error
                createFallbackSectorChart(data);
            });
    }

    function createSectorRaceChart(sectorStatusData) {
        // Sector display names mapping (using proper names from model choices)
        const sectorDisplayNames = {
            'student': 'College Students in need of Educational Assistance',
            'delivery_riders': 'Delivery Riders',
            'dressmaker_weaver': 'Dressmaker/Weaver',
            'farmer': 'Farmers',
            'fisherman': 'Fishermen',
            'women_mothers': 'Learning Women/Mothers (Ummahat)',
            'mujahidin': 'Mujahidin/Mujahidat',
            'special_needs': 'Parents/Guardians of Children with Special Needs',
            'pwd_student': 'Person with Disability (PWD)',
            'volunteer_teacher': 'Public School Volunteer Teachers (English/Arabic)',
            'small_time_vendor': 'Small-time Vendors',
            'solo_parent': 'Solo Parents',
            'volunteer_health': 'Volunteer Health Workers',
            'lgbtq_community': 'LGBTQ+ Community Members',
            'out_of_school': 'Out-of-School Youth',
            'senior_citizen': 'Senior Citizens',
            'indigenous_people': 'Indigenous Peoples',
            'victim_of_abuse': 'Victims of Abuse',
            'overseas_worker': 'Overseas Workers',
            'probationary_member': 'Probationary Members'
        };

        // Group data by sector
        const sectorGroups = {};
        sectorStatusData.forEach(item => {
            const sectorName = sectorDisplayNames[item.sector] || item.sector;
            if (!sectorGroups[sectorName]) {
                sectorGroups[sectorName] = {};
            }
            sectorGroups[sectorName][item.status] = item.count;
        });

        // Prepare data for race chart
        const sectors = Object.keys(sectorGroups).map(sector => sectorDisplayNames[sector] || sector);
        const statuses = ['approved', 'pending', 'incomplete', 'archived'];
        const statusColors = {
            'approved': '#10B981', // Green
            'pending': '#FBBF24', // Yellow
            'incomplete': '#EF4444', // Red
            'archived': '#6B7280' // Grey
        };

        // Create datasets for each status
        const datasets = statuses.map(status => ({
            label: status.charAt(0).toUpperCase() + status.slice(1),
            data: sectors.map(sector => sectorGroups[sector][status] || 0),
            backgroundColor: statusColors[status],
            borderColor: statusColors[status],
            borderWidth: 1,
            borderRadius: 4,
            borderSkipped: false,
        }));

        if (sectorChart) sectorChart.destroy();
        sectorChart = new Chart(sectorChartCtx, {
            type: 'bar',
            data: {
                labels: sectors,
                datasets: datasets
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 2000,
                    easing: 'easeOutQuart',
                    onComplete: function() {
                        // Animation complete callback
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 11
                            },
                            boxWidth: 12,
                            boxHeight: 12
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#e5e7eb',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                // Calculate total for this sector
                                const sectorIndex = context[0].dataIndex;
                                let total = 0;
                                context.chart.data.datasets.forEach(dataset => {
                                    total += dataset.data[sectorIndex] || 0;
                                });
                                const value = context.parsed.x;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${context.dataset.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 11
                            }
                        }
                    },
                    y: {
                        stacked: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });

        // Hide loading indicator
        document.getElementById('sectorChartLoading').style.display = 'none';
    }

    function createFallbackSectorChart(data) {
        console.log('Creating fallback sector chart');
        const sectorDisplayNames = {
            'student': 'College Students in need of Educational Assistance',
            'delivery_riders': 'Delivery Riders',
            'dressmaker_weaver': 'Dressmaker/Weaver',
            'lgbtq': 'LGBTQ+ Community',
            'out_of_school': 'Out-of-School Youth',
            'solo_parent': 'Solo Parents',
            'pwd': 'Persons with Disabilities',
            'senior_citizen': 'Senior Citizens',
            'indigenous_people': 'Indigenous Peoples',
            'victim_of_abuse': 'Victims of Abuse',
            'overseas_worker': 'Overseas Workers',
            'probationary_member': 'Probationary Members'
        };

        const labels = data.map(item => sectorDisplayNames[item.sector] || item.sector);
        const counts = data.map(item => item.count);

        if (sectorChart) sectorChart.destroy();
        sectorChart = new Chart(sectorChartCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Members',
                    data: counts,
                    backgroundColor: '#8B5CF6',
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });

        // Hide loading indicator
        document.getElementById('sectorChartLoading').style.display = 'none';
    }

    function updateRegistrationTrendChart(data) {
        console.log('Updating registration trend chart with data:', data);
        const labels = data.map(item => item.date);
        const counts = data.map(item => item.count);

        if (registrationTrendChart) registrationTrendChart.destroy();
        registrationTrendChart = new Chart(registrationTrendChartCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Daily Registrations',
                    data: counts,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });

        // Hide loading indicator
        document.getElementById('registrationTrendLoading').style.display = 'none';
    }

    function updateSectorStatusRaceChart(data) {
        console.log('Updating sector status race chart with data:', data);

        // Sector display names mapping (using proper names from model choices)
        const sectorDisplayNames = {
            'student': 'College Students in need of Educational Assistance',
            'delivery_riders': 'Delivery Riders',
            'dressmaker_weaver': 'Dressmaker/Weaver',
            'farmer': 'Farmers',
            'fisherman': 'Fishermen',
            'women_mothers': 'Learning Women/Mothers (Ummahat)',
            'mujahidin': 'Mujahidin/Mujahidat',
            'special_needs': 'Parents/Guardians of Children with Special Needs',
            'pwd_student': 'Person with Disability (PWD)',
            'volunteer_teacher': 'Public School Volunteer Teachers (English/Arabic)',
            'small_time_vendor': 'Small-time Vendors',
            'solo_parent': 'Solo Parents',
            'volunteer_health': 'Volunteer Health Workers',
            'lgbtq_community': 'LGBTQ+ Community Members',
            'out_of_school': 'Out-of-School Youth',
            'senior_citizen': 'Senior Citizens',
            'indigenous_people': 'Indigenous Peoples',
            'victim_of_abuse': 'Victims of Abuse',
            'overseas_worker': 'Overseas Workers',
            'probationary_member': 'Probationary Members'
        };

        const labels = data.map(item => (sectorDisplayNames[item.sector] || item.sector) + ' - ' + item.status);
        const counts = data.map(item => item.count);

        if (sectorStatusRaceChart) sectorStatusRaceChart.destroy();
        sectorStatusRaceChart = new Chart(sectorStatusRaceChartCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Count',
                    data: counts,
                    backgroundColor: '#F59E0B',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 10
                            },
                            maxRotation: 45
                        }
                    }
                }
            }
        });

        // Hide loading indicator
        document.getElementById('sectorStatusChartLoading').style.display = 'none';
    }
});
</script>
{% endblock %}
